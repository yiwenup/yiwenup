<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=X-UA-Compatible content="IE=edge, chrome=1"><title>02 Netty线程模型 - Yiwenup - 持续沉淀</title><meta name=Description content="Yiwenup - 持续沉淀"><meta property="og:url" content="http://www.yiwenup.cloud/netty%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B/">
<meta property="og:site_name" content="Yiwenup - 持续沉淀"><meta property="og:title" content="02 Netty线程模型"><meta property="og:description" content="一、Reactor线程模型 传统的线程模型，是阻塞的，比如Socket编程，服务端对于一个客户端连接请求必须分配一个线程处理，如果这个请求所访"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-02-06T09:37:34+08:00"><meta property="article:modified_time" content="2024-02-06T09:37:34+08:00"><meta property="article:tag" content="Netty"><meta property="og:image" content="http://www.yiwenup.cloud/logo.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://www.yiwenup.cloud/logo.png"><meta name=twitter:title content="02 Netty线程模型"><meta name=twitter:description content="一、Reactor线程模型 传统的线程模型，是阻塞的，比如Socket编程，服务端对于一个客户端连接请求必须分配一个线程处理，如果这个请求所访"><meta name=application-name content="Yiwenup - 持续沉淀"><meta name=apple-mobile-web-app-title content="Yiwenup - 持续沉淀"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://www.yiwenup.cloud/netty%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B/><link rel=prev href=http://www.yiwenup.cloud/io%E6%A8%A1%E5%9E%8B/><link rel=next href=http://www.yiwenup.cloud/freemarker%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8C%87%E4%BB%A4%E4%B8%8E%E5%9C%BA%E6%99%AF/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"02 Netty线程模型","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/www.yiwenup.cloud\/netty%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B\/"},"image":["http:\/\/www.yiwenup.cloud\/images\/Apple-Devices-Preview.png"],"genre":"posts","keywords":"Netty","wordcount":1606,"url":"http:\/\/www.yiwenup.cloud\/netty%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B\/","datePublished":"2024-02-06T09:37:34+08:00","dateModified":"2024-02-06T09:37:34+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"xxxx","logo":{"@type":"ImageObject","url":"http:\/\/www.yiwenup.cloud\/images\/avatar.png","width":320,"height":320}},"author":{"@type":"Person","name":"yiwenup"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Yiwenup - 持续沉淀"><span class=header-title-pre><i class='fas fa-piggy-bank'></i></span> Yiwen Up <span class=header-title-post><i class='fas fa-leaf'></i></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/categories/><i class='fas fa-folder-open'></i> 分类 </a><a class=menu-item href=/tags/><i class='fas fa-tags fa-fw'></i> 标签 </a><a class=menu-item href=/posts/><i class='fas fa-book'></i> 所有文章 </a><a class=menu-item href=/></a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Yiwenup - 持续沉淀"><span class=header-title-pre><i class='fas fa-piggy-bank'></i></span> Yiwen Up <span class=header-title-post><i class='fas fa-leaf'></i></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/categories/ title><i class='fas fa-folder-open'></i>分类</a><a class=menu-item href=/tags/ title><i class='fas fa-tags fa-fw'></i>标签</a><a class=menu-item href=/posts/ title><i class='fas fa-book'></i>所有文章</a><a class=menu-item href=/ title></a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">02 Netty线程模型</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-feather-alt"></i></a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/><i class="far fa-folder fa-fw"></i>网络编程</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2024-02-06>2024-02-06</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 1606 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 4 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#一reactor线程模型>一、Reactor线程模型</a></li><li><a href=#二netty线程模型>二、Netty线程模型</a></li></ul></li></ul></nav></div></div><div class=content id=content><h2 id=一reactor线程模型>一、Reactor线程模型</h2><p>传统的线程模型，是阻塞的，比如<code>Socket</code>编程，服务端对于一个客户端连接请求必须分配一个线程处理，如果这个请求所访问的资源尚未就绪，那么线程就会一直阻塞等待资源访问完成。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=../images/image-20240612210644973.png data-srcset="../images/image-20240612210644973.png, ../images/image-20240612210644973.png 1.5x, ../images/image-20240612210644973.png 2x" data-sizes=auto alt=../images/image-20240612210644973.png title=image-20240612210644973></p><p>这种模式的缺点就是：当并发量上来的时候，服务端线程资源会快速占用，如果某些请求还阻塞了，那么服务器资源就会被消耗殆尽。</p><p>基于传统阻塞式<code>I/O</code>模型的问题，<code>Reactor</code>模式使用<code>I/O</code>复用监听事件的方式，将请求连接和业务处理解耦开来，由专门的线程监听连接事件，并将连接处理之后分派给其余线程继续业务处理。</p><p><code>Reactor</code>模型有三种模式：</p><ul><li><p>单<code>Reactor</code>单线程：Reactor 对象通过 Selector监控客户端请求事件，收到事件后通过 Dispatch 进行分发；如果是建立连接请求事件，则由 Acceptor 通过 Accept 处理连接请求，然后创建一个 Handler 对象处理连接完成后的后续业务处理。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=../images/image-20240612214340633.png data-srcset="../images/image-20240612214340633.png, ../images/image-20240612214340633.png 1.5x, ../images/image-20240612214340633.png 2x" data-sizes=auto alt=../images/image-20240612214340633.png title=image-20240612214340633></p></li><li><p>单<code>Reactor</code>多线程：Reactor 对象通过 Selector 监控客户端请求事件，收到事件后，通过 Dispatch 进行分发；如果建立连接请求，则由 Acceptor 通过 Accept 处理连接请求；如果不是连接请求，则由 Reactor 分发调用连接对应的 Handler 来处理；Handler 只负责响应事件，不做具体的业务处理，进一步分发给后面的 worker 线程池的某个线程处理业务；Worker 线程池会分配独立线程完成真正的业务，并将结果返回给 Handler；Handler 收到响应后，再将结果返回给客户端。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=../images/image-20240612214424651.png data-srcset="../images/image-20240612214424651.png, ../images/image-20240612214424651.png 1.5x, ../images/image-20240612214424651.png 2x" data-sizes=auto alt=../images/image-20240612214424651.png title=image-20240612214424651></p></li><li><p>主从<code>Reactor</code>多线程：Reactor 主线程 MainReactor 对象通过 Selector 监听客户端连接事件，收到事件后，通过 Acceptor 处理客户端连接事件；当 Acceptor 处理完客户端连接事件之后（与客户端建立好 Socket 连接），MainReactor 将连接分配给 SubReactor；SubReactor 将连接加入到自己的连接队列进行监听，并创建 Handler 对各种事件进行处理；当连接上有新事件发生的时候，SubReactor 就会调用对应的 Handler 处理；Handler 从连接上读取请求数据，将请求数据分发给 Worker 线程池进行业务处理；Worker 线程池会分配独立线程来完成真正的业务处理，并将处理结果返回给 Handler，Handler 向客户端发送响应数据；一个 MainReactor 可以对应多个 SubReactor，即一个 MainReactor 线程可以对应多个 SubReactor 线程。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=../images/image-20240612214448283.png data-srcset="../images/image-20240612214448283.png, ../images/image-20240612214448283.png 1.5x, ../images/image-20240612214448283.png 2x" data-sizes=auto alt=../images/image-20240612214448283.png title=image-20240612214448283></p></li></ul><h2 id=二netty线程模型>二、Netty线程模型</h2><blockquote><p><code>Netty</code>就是在主从<code>Reactor</code>多线程模式的基础上，做了一定的改进。</p></blockquote><p><img class=lazyload src=/svg/loading.min.svg data-src=../images/image-20240612214620404.png data-srcset="../images/image-20240612214620404.png, ../images/image-20240612214620404.png 1.5x, ../images/image-20240612214620404.png 2x" data-sizes=auto alt=../images/image-20240612214620404.png title=image-20240612214620404></p><ul><li>Netty 抽象出两组线程池：BossGroup 和 WorkerGroup，也可以叫做 BossNioEventLoopGroup 和 WorkerNioEventLoopGroup。每个线程池中都有 NioEventLoop 线程。<strong>BossGroup 中的线程专门负责和客户端建立连接，WorkerGroup 中的线程专门负责处理连接上的读写</strong>。BossGroup 和 WorkerGroup 的类型都是 NioEventLoopGroup。</li><li>NioEventLoopGroup 相当于一个事件循环组，这个组中含有多个事件循环，每个事件循环就是一个 NioEventLoop</li><li>NioEventLoop 表示一个不断循环的执行事件处理的线程，每个 NioEventLoop 都包含一个 Selector，用于监听注册在其上的 Socket 网络连接（Channel）</li><li>NioEventLoopGroup 可以含有多个线程，即可以含有多个 NioEventLoop</li><li>每个 BossNioEventLoop 中循环执行以下三个步骤<ul><li><strong>select</strong>：轮训注册在其上的 ServerSocketChannel 的 accept 事件（OP_ACCEPT 事件）</li><li><strong>processSelectedKeys</strong>：处理 accept 事件，与客户端建立连接，生成一个 NioSocketChannel，并将其注册到某个 WorkerNioEventLoop 上的 Selector 上</li><li><strong>runAllTasks</strong>：再去以此循环处理任务队列中的其他任务</li></ul></li><li>每个 WorkerNioEventLoop 中循环执行以下三个步骤<ul><li><strong>select</strong>：轮训注册在其上的 NioSocketChannel 的 read/write 事件（OP_READ/OP_WRITE 事件）</li><li><strong>processSelectedKeys</strong>：在对应的 NioSocketChannel 上处理 read/write 事件</li><li><strong>runAllTasks</strong>：再去以此循环处理任务队列中的其他任务</li></ul></li><li>在以上两个<strong>processSelectedKeys</strong>步骤中，会使用 Pipeline（管道），Pipeline 中引用了 Channel，即通过 Pipeline 可以获取到对应的 Channel，Pipeline 中维护了很多的处理器（拦截处理器、过滤处理器、自定义处理器等）。</li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2024-02-06</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/netty/>Netty</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/io%E6%A8%A1%E5%9E%8B/ class=prev rel=prev title="01 I/O模型"><i class="fas fa-angle-left fa-fw"></i>01 I/O模型</a>
<a href=/freemarker%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8C%87%E4%BB%A4%E4%B8%8E%E5%9C%BA%E6%99%AF/ class=next rel=next title=Freemarker自定义指令与场景>Freemarker自定义指令与场景<i class="fas fa-angle-right fa-fw"></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2021 - 2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>yiwenup</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/twemoji@13.0.0/dist/twemoji.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:0},comment:{},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},twemoji:!0}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>