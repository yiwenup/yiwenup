<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>01. Spring Framework - IOC - Yiwenup - 持续沉淀</title><meta name=Description content="Yiwenup - 持续沉淀"><meta property="og:title" content="01. Spring Framework - IOC"><meta property="og:description" content="零、IOC 容器初始化三大步 this() register(componentClasses) refresh() 一、this 调用父类的构造函数，初始化BeanFactory 1 2 // DefaultListableBeanFactory 是 BeanFactory 最底层的、功能最全的实现，即我们常说"><meta property="og:type" content="article"><meta property="og:url" content="http://www.yiwenup.cloud/spring%E6%8E%A2%E7%B4%A2-ioc/"><meta property="og:image" content="http://www.yiwenup.cloud/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-06-15T19:12:32+08:00"><meta property="article:modified_time" content="2022-06-15T19:12:32+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://www.yiwenup.cloud/logo.png"><meta name=twitter:title content="01. Spring Framework - IOC"><meta name=twitter:description content="零、IOC 容器初始化三大步 this() register(componentClasses) refresh() 一、this 调用父类的构造函数，初始化BeanFactory 1 2 // DefaultListableBeanFactory 是 BeanFactory 最底层的、功能最全的实现，即我们常说"><meta name=application-name content="Yiwenup - 持续沉淀"><meta name=apple-mobile-web-app-title content="Yiwenup - 持续沉淀"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://www.yiwenup.cloud/spring%E6%8E%A2%E7%B4%A2-ioc/><link rel=prev href=http://www.yiwenup.cloud/spring%E5%9F%BA%E7%A1%80/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"01. Spring Framework - IOC","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/www.yiwenup.cloud\/spring%E6%8E%A2%E7%B4%A2-ioc\/"},"image":["http:\/\/www.yiwenup.cloud\/images\/Apple-Devices-Preview.png"],"genre":"posts","keywords":"Spring生态, IOC","wordcount":3258,"url":"http:\/\/www.yiwenup.cloud\/spring%E6%8E%A2%E7%B4%A2-ioc\/","datePublished":"2022-06-15T19:12:32+08:00","dateModified":"2022-06-15T19:12:32+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"xxxx","logo":{"@type":"ImageObject","url":"http:\/\/www.yiwenup.cloud\/images\/avatar.png","width":177,"height":177}},"author":{"@type":"Person","name":"yiwenup"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Yiwenup - 持续沉淀"><span class=header-title-pre><i class='fas fa-piggy-bank'></i></span> Yiwen Up <span class=header-title-post><i class='fas fa-leaf'></i></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/categories/><i class='fas fa-folder-open'></i> 分类 </a><a class=menu-item href=/tags/><i class='fas fa-tags fa-fw'></i> 标签 </a><a class=menu-item href=/posts/><i class='fas fa-book'></i> 所有文章 </a><a class=menu-item href=/></a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Yiwenup - 持续沉淀"><span class=header-title-pre><i class='fas fa-piggy-bank'></i></span> Yiwen Up <span class=header-title-post><i class='fas fa-leaf'></i></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/categories/ title><i class='fas fa-folder-open'></i>分类</a><a class=menu-item href=/tags/ title><i class='fas fa-tags fa-fw'></i>标签</a><a class=menu-item href=/posts/ title><i class='fas fa-book'></i>所有文章</a><a class=menu-item href=/ title></a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">01. Spring Framework - IOC</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-feather-alt"></i></a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/spring/><i class="far fa-folder fa-fw"></i>Spring</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-06-15>2022-06-15</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 3258 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 7 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#零ioc-容器初始化三大步>零、IOC 容器初始化三大步</a></li><li><a href=#一this>一、this</a></li><li><a href=#二register>二、register</a></li><li><a href=#三refresh容器刷新十三步>三、refresh（容器刷新十三步）</a><ul><li><a href=#31-preparerefresh>3.1 prepareRefresh</a></li><li><a href=#32-obtainfreshbeanfactory>3.2 obtainFreshBeanFactory</a></li><li><a href=#33-preparebeanfactory>3.3 prepareBeanFactory</a></li><li><a href=#34-postprocessbeanfactory>3.4 postProcessBeanFactory</a></li><li><a href=#35-invokebeanfactorypostprocessors>3.5 invokeBeanFactoryPostProcessors</a></li><li><a href=#36-registerbeanpostprocessors>3.6 registerBeanPostProcessors</a></li><li><a href=#37-initmessagesource>3.7 initMessageSource</a></li><li><a href=#38-initapplicationeventmulticaster>3.8 initApplicationEventMulticaster</a></li><li><a href=#39-onrefresh>3.9 onRefresh</a></li><li><a href=#310-registerlisteners>3.10 registerListeners</a></li><li><a href=#311-finishbeanfactoryinitialization>3.11 finishBeanFactoryInitialization</a></li><li><a href=#312-finishrefresh>3.12 finishRefresh</a></li><li><a href=#313-resetcommoncaches>3.13 resetCommonCaches</a></li></ul></li></ul></li></ul></nav></div></div><div class=content id=content><h2 id=零ioc-容器初始化三大步>零、IOC 容器初始化三大步</h2><p><img class=lazyload src=/svg/loading.min.svg data-src=../images/image-20220615143657406.png data-srcset="../images/image-20220615143657406.png, ../images/image-20220615143657406.png 1.5x, ../images/image-20220615143657406.png 2x" data-sizes=auto alt=../images/image-20220615143657406.png title=image-20220615143657406></p><ul><li>this()</li><li>register(componentClasses)</li><li><strong>refresh()</strong></li></ul><h2 id=一this>一、this</h2><p><img class=lazyload src=/svg/loading.min.svg data-src=../images/image-20220615160900332.png data-srcset="../images/image-20220615160900332.png, ../images/image-20220615160900332.png 1.5x, ../images/image-20220615160900332.png 2x" data-sizes=auto alt=../images/image-20220615160900332.png title=image-20220615160900332></p><ul><li><p>调用父类的构造函数，初始化<code>BeanFactory</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// DefaultListableBeanFactory 是 BeanFactory 最底层的、功能最全的实现，即我们常说的 IOC 容器。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>this</span><span class=o>.</span><span class=na>beanFactory</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DefaultListableBeanFactory</span><span class=o>();</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>初始化<code>BeanDefinitionReader</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 过程中主要做了两件事：注册内置的 BeanPostProcessor，注册内置的核心 BeanDefinition
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>this</span><span class=o>.</span><span class=na>reader</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AnnotatedBeanDefinitionReader</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>条件表达式计算初始化</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 初始化条件表达式计算
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>this</span><span class=o>.</span><span class=na>conditionEvaluator</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ConditionEvaluator</span><span class=o>(</span><span class=n>registry</span><span class=o>,</span> <span class=n>environment</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=nf>ConditionContextImpl</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>BeanDefinitionRegistry</span> <span class=n>registry</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                            <span class=nd>@Nullable</span> <span class=n>Environment</span> <span class=n>environment</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>ResourceLoader</span> <span class=n>resourceLoader</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 设置 IOC 容器的 ApplicationContext 对象
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=o>.</span><span class=na>registry</span> <span class=o>=</span> <span class=n>registry</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 设置 BeanFactory 对象
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=o>.</span><span class=na>beanFactory</span> <span class=o>=</span> <span class=n>deduceBeanFactory</span><span class=o>(</span><span class=n>registry</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// // 设置环境对象
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=o>.</span><span class=na>environment</span> <span class=o>=</span> <span class=o>(</span><span class=n>environment</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>environment</span> <span class=o>:</span> <span class=n>deduceEnvironment</span><span class=o>(</span><span class=n>registry</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 设置资源加载对象
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=o>.</span><span class=na>resourceLoader</span> <span class=o>=</span> <span class=o>(</span><span class=n>resourceLoader</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>resourceLoader</span> <span class=o>:</span> <span class=n>deduceResourceLoader</span><span class=o>(</span><span class=n>registry</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 设置类加载器
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=o>.</span><span class=na>classLoader</span> <span class=o>=</span> <span class=n>deduceClassLoader</span><span class=o>(</span><span class=n>resourceLoader</span><span class=o>,</span> <span class=k>this</span><span class=o>.</span><span class=na>beanFactory</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>注册核心组件，包含一些<strong>内置</strong>的<code>BeanDefinition</code>/<code>PostProcessor</code></p></li></ul><p><img class=lazyload src=/svg/loading.min.svg data-src=../images/image-20220615163532361.png data-srcset="../images/image-20220615163532361.png, ../images/image-20220615163532361.png 1.5x, ../images/image-20220615163532361.png 2x" data-sizes=auto alt=../images/image-20220615163532361.png title=image-20220615163532361></p><blockquote><ul><li><p>解析配置类的组件（会解析加了**@Configuration的配置类**，以及**@ComponentScan**、<strong>@ComponentScans</strong>注解扫描的包，还会解析**@Bean**、<strong>@Import</strong>等注解的类）：</p><p>internalConfigurationAnnotationProcessor => ConfigurationAnnotationProcessor</p></li><li><p>解析 @Autowired 的组件：</p><p>internalAutowiredAnnotationProcessor => AutowiredAnnotationBeanPostProcessor</p></li><li><p>解析 @Resourece/@WebServiceRef/@EJB 注解的组件：</p><p>internalCommonAnnotationProcessor => CommonAnnotationBeanPostProcessor</p></li><li><p>处理 @EventListener 的组件：</p><p>internalEventListenerFactory => DefaultEventListenerFactory</p><p>internalEventListenerProcessor => EventListenerMethodProcessor</p></li></ul></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 注册核心的组件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>AnnotationConfigUtils</span><span class=o>.</span><span class=na>registerAnnotationConfigProcessors</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>registry</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 为容器中注册解析配置类的后置处理器 ConfigurationClassPostProcessor
</span></span></span><span class=line><span class=cl><span class=cm> * org.springframework.context.annotation.internalConfigurationAnnotationProcessor
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>(!</span><span class=n>registry</span><span class=o>.</span><span class=na>containsBeanDefinition</span><span class=o>(</span><span class=n>CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>   <span class=n>RootBeanDefinition</span> <span class=n>def</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RootBeanDefinition</span><span class=o>(</span><span class=n>ConfigurationClassPostProcessor</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>   <span class=n>def</span><span class=o>.</span><span class=na>setSource</span><span class=o>(</span><span class=n>source</span><span class=o>);</span>
</span></span><span class=line><span class=cl>   <span class=n>beanDefs</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>registerPostProcessor</span><span class=o>(</span><span class=n>registry</span><span class=o>,</span> <span class=n>def</span><span class=o>,</span> <span class=n>CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 这方法为BeanDefinition设置了一个Role，ROLE_INFRASTRUCTURE代表这是spring内部的，并非用户定义的
</span></span></span><span class=line><span class=cl><span class=cm> * registry.registerBeanDefinition(beanName, definition);是一个接口方法，
</span></span></span><span class=line><span class=cl><span class=cm> * 实现类是 DefaultListableBeanFactory
</span></span></span><span class=line><span class=cl><span class=cm> *    核心工作就是
</span></span></span><span class=line><span class=cl><span class=cm> *    a.this.beanDefinitionMap.put(beanName, beanDefinition);
</span></span></span><span class=line><span class=cl><span class=cm> *      把beanName作为key，beanDefinition作为value，放到map里面
</span></span></span><span class=line><span class=cl><span class=cm> *    b.beanDefinitionNames就是一个List&lt;String&gt;,这里就是把beanName放到List中去
</span></span></span><span class=line><span class=cl><span class=cm> * DefaultListableBeanFactory就是我们所说的容器,里面放着beanDefinitionMap， beanDefinitionNames，
</span></span></span><span class=line><span class=cl><span class=cm> *      beanDefinitionMap是一个hashMap，beanName作为Key,beanDefinition作为Value，
</span></span></span><span class=line><span class=cl><span class=cm> *      beanDefinitionNames是一个集合，里面存放了beanName
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=n>BeanDefinitionHolder</span> <span class=nf>registerPostProcessor</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>BeanDefinitionRegistry</span> <span class=n>registry</span><span class=o>,</span> <span class=n>RootBeanDefinition</span> <span class=n>definition</span><span class=o>,</span> <span class=n>String</span> <span class=n>beanName</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>definition</span><span class=o>.</span><span class=na>setRole</span><span class=o>(</span><span class=n>BeanDefinition</span><span class=o>.</span><span class=na>ROLE_INFRASTRUCTURE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 核心已在上方注释
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>registry</span><span class=o>.</span><span class=na>registerBeanDefinition</span><span class=o>(</span><span class=n>beanName</span><span class=o>,</span> <span class=n>definition</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>BeanDefinitionHolder</span><span class=o>(</span><span class=n>definition</span><span class=o>,</span> <span class=n>beanName</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><hr><ul><li><p>初始化<code>ClassPathBeanDefinitionScanner</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>this</span><span class=o>.</span><span class=na>scanner</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ClassPathBeanDefinitionScanner</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div></li></ul><h2 id=二register>二、register</h2><blockquote><p>将从<code>ApplicationContext</code>中<strong>导入的配置类</strong>封装为一个<code>BeanDefinition</code>，仅封装<code>BeanDefinition</code>，<strong>此时尚未进行实例化</strong></p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * register 的核心逻辑
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kt>void</span> <span class=nf>doRegisterBean</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>beanClass</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>String</span> <span class=n>name</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>Class</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>Annotation</span><span class=o>&gt;[]</span> <span class=n>qualifiers</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>Supplier</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>supplier</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>BeanDefinitionCustomizer</span><span class=o>[]</span> <span class=n>customizers</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>AnnotatedGenericBeanDefinition</span> <span class=n>abd</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AnnotatedGenericBeanDefinition</span><span class=o>(</span><span class=n>beanClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 判断是否需要跳过注解，spring中有一个@Condition注解，当不满足条件，这个bean就不会被解析
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>conditionEvaluator</span><span class=o>.</span><span class=na>shouldSkip</span><span class=o>(</span><span class=n>abd</span><span class=o>.</span><span class=na>getMetadata</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>abd</span><span class=o>.</span><span class=na>setInstanceSupplier</span><span class=o>(</span><span class=n>supplier</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 解析bean的作用域，如果没有设置的话，默认为单例
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ScopeMetadata</span> <span class=n>scopeMetadata</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>scopeMetadataResolver</span><span class=o>.</span><span class=na>resolveScopeMetadata</span><span class=o>(</span><span class=n>abd</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>abd</span><span class=o>.</span><span class=na>setScope</span><span class=o>(</span><span class=n>scopeMetadata</span><span class=o>.</span><span class=na>getScopeName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 获得beanName
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>String</span> <span class=n>beanName</span> <span class=o>=</span> <span class=o>(</span><span class=n>name</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>name</span> <span class=o>:</span> <span class=k>this</span><span class=o>.</span><span class=na>beanNameGenerator</span><span class=o>.</span><span class=na>generateBeanName</span><span class=o>(</span><span class=n>abd</span><span class=o>,</span> <span class=k>this</span><span class=o>.</span><span class=na>registry</span><span class=o>))</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 解析通用注解，填充到AnnotatedGenericBeanDefinition
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 解析的注解 Lazy，Primary，DependsOn，Role，Description
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>AnnotationConfigUtils</span><span class=o>.</span><span class=na>processCommonDefinitionAnnotations</span><span class=o>(</span><span class=n>abd</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>qualifiers</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=n>Class</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>Annotation</span><span class=o>&gt;</span> <span class=n>qualifier</span> <span class=o>:</span> <span class=n>qualifiers</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>Primary</span><span class=o>.</span><span class=na>class</span> <span class=o>==</span> <span class=n>qualifier</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>abd</span><span class=o>.</span><span class=na>setPrimary</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>Lazy</span><span class=o>.</span><span class=na>class</span> <span class=o>==</span> <span class=n>qualifier</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>abd</span><span class=o>.</span><span class=na>setLazyInit</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>abd</span><span class=o>.</span><span class=na>addQualifier</span><span class=o>(</span><span class=k>new</span> <span class=n>AutowireCandidateQualifier</span><span class=o>(</span><span class=n>qualifier</span><span class=o>));</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>customizers</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=n>BeanDefinitionCustomizer</span> <span class=n>customizer</span> <span class=o>:</span> <span class=n>customizers</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>customizer</span><span class=o>.</span><span class=na>customize</span><span class=o>(</span><span class=n>abd</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>BeanDefinitionHolder</span> <span class=n>definitionHolder</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BeanDefinitionHolder</span><span class=o>(</span><span class=n>abd</span><span class=o>,</span> <span class=n>beanName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>definitionHolder</span> <span class=o>=</span> <span class=n>AnnotationConfigUtils</span><span class=o>.</span><span class=na>applyScopedProxyMode</span><span class=o>(</span><span class=n>scopeMetadata</span><span class=o>,</span> <span class=n>definitionHolder</span><span class=o>,</span> <span class=k>this</span><span class=o>.</span><span class=na>registry</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 注册，最终会调用DefaultListableBeanFactory中的registerBeanDefinition方法去注册
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>BeanDefinitionReaderUtils</span><span class=o>.</span><span class=na>registerBeanDefinition</span><span class=o>(</span><span class=n>definitionHolder</span><span class=o>,</span> <span class=k>this</span><span class=o>.</span><span class=na>registry</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>通过 <code>AnnotatedGenericBeanDefinition</code> 的构造方法，获得配置类的 <code>BeanDefinition</code></li><li>判断需不需要跳过注册，Spring 中有一个 <code>@Condition</code> 注解，如果不满足条件，就会跳过这个类的注册</li><li>解析作用域，如果没有设置的话，默认为单例</li><li>获得 <code>BeanName</code></li><li>解析通用注解（<code>@Lazy</code>/<code>@Primary</code>/<code>@DependsOn</code>/<code>@Role</code>/<code>@Description</code>）并填充到 <code>AnnotatedGenericBeanDefinition</code></li><li>限定符处理，不是特指<code>@Qualifier</code>注解，也有可能是<code>@Primary</code>，或者是<code>@Lazy</code>，或者是其他</li><li>把<code>AnnotatedGenericBeanDefinition</code>数据结构和<code>beanName</code>封装到一个对象中（方便传参）</li><li>注册，最终会调用<code>DefaultListableBeanFactory</code>中的 <code>registerBeanDefinition() </code>方法</li></ul><h2 id=三refresh容器刷新十三步>三、refresh（容器刷新十三步）</h2><blockquote><p>以上两大步只是实例化了一个工厂，然后初始化了一些核心 Bean，以及一些配置类。</p><p>refresh() 方法这一步将会做具体业务 Bean 的实例化和后续功能的完善</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>refresh</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>BeansException</span><span class=o>,</span> <span class=n>IllegalStateException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>   <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>startupShutdownMonitor</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 1:准备刷新上下文环境
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// 刷新预处理，和主流程关系不大，就是保存了容器的启动时间，启动标志等
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>prepareRefresh</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>//2:告诉子类初始化Bean工厂(MVC),获取Bean工厂
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// 和主流程关系也不大，最终获得了DefaultListableBeanFactory
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>ConfigurableListableBeanFactory</span> <span class=n>beanFactory</span> <span class=o>=</span> <span class=n>obtainFreshBeanFactory</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// 3:对Bean工厂进行填充属性
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * ①添加了两个后置处理器：
</span></span></span><span class=line><span class=cl><span class=cm>       *    a.ApplicationContextAwareProcessor
</span></span></span><span class=line><span class=cl><span class=cm>       *    b.ApplicationListenerDetector
</span></span></span><span class=line><span class=cl><span class=cm>       * ②设置忽略自动装配和允许自动装配的接口,如果不存在某个bean的时候，
</span></span></span><span class=line><span class=cl><span class=cm>       *  spring就自动注册singleton bean
</span></span></span><span class=line><span class=cl><span class=cm>       * ③ 设置了bean表达式解析器
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=n>prepareBeanFactory</span><span class=o>(</span><span class=n>beanFactory</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>         <span class=c1>// 4:空方法 留给子类去实现该接口 允许在上下文子类中对Bean工厂进行后置处理。
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=n>postProcessBeanFactory</span><span class=o>(</span><span class=n>beanFactory</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>         <span class=c1>// 5:调用Bean工厂的后置处理器.
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=c1>// 执行自定义的BeanFactoryPostProcessor和内置的BeanFactoryPostProcessor
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=n>invokeBeanFactoryPostProcessors</span><span class=o>(</span><span class=n>beanFactory</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>         <span class=c1>// 6:注册BeanPostProcessors
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=n>registerBeanPostProcessors</span><span class=o>(</span><span class=n>beanFactory</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>         <span class=c1>// 7:初始化国际化资源处理器.
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=n>initMessageSource</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>         <span class=c1>// 8:创建事件多播器
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=n>initApplicationEventMulticaster</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>         <span class=c1>// 9:这个方法同样也是留个子类实现的springboot也是从这个方法进行启动tomcat的.
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=c1>// 模板方法，在容器刷新的时候可以自定义逻辑，不同的Spring容器做不同的事情
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=n>onRefresh</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>         <span class=c1>// 10:将事件监听器注册到多播器上
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=n>registerListeners</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>         <span class=c1>// 11:实例化懒加载单例Bean的，也就是Bean绝大部分都是在这里被创建出来的
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=n>finishBeanFactoryInitialization</span><span class=o>(</span><span class=n>beanFactory</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>         <span class=c1>// 12:最后容器刷新 发布刷新事件(Spring cloud也是从这里启动的)
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=n>finishRefresh</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>catch</span> <span class=o>(</span><span class=n>BeansException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>         <span class=k>if</span> <span class=o>(</span><span class=n>logger</span><span class=o>.</span><span class=na>isWarnEnabled</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=na>warn</span><span class=o>(</span><span class=s>&#34;Exception encountered during context initialization - &#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                  <span class=s>&#34;cancelling refresh attempt: &#34;</span> <span class=o>+</span> <span class=n>ex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>         <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>         <span class=c1>// Destroy already created singletons to avoid dangling resources.
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=n>destroyBeans</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>         <span class=c1>// Reset &#39;active&#39; flag.
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=n>cancelRefresh</span><span class=o>(</span><span class=n>ex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>         <span class=k>throw</span> <span class=n>ex</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>         <span class=c1>// 13.清除元数据缓冲，实例化后就不需要了
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=n>resetCommonCaches</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=31-preparerefresh>3.1 prepareRefresh</h3><blockquote><p>准备刷新上下文环境</p></blockquote><h3 id=32-obtainfreshbeanfactory>3.2 obtainFreshBeanFactory</h3><blockquote><p>告诉子类初始化Bean工厂(MVC),获取Bean工厂</p></blockquote><h3 id=33-preparebeanfactory>3.3 prepareBeanFactory</h3><blockquote><p>对Bean工厂进行填充属性</p></blockquote><ul><li>设置了一个类加载器</li><li>设置了bean表达式解析器</li><li>添加了属性编辑器的支持</li><li>添加了一个后置处理器：<code>ApplicationContextAwareProcessor</code>，此后置处理器实现了BeanPostProcessor接口</li><li>设置了一些忽略自动装配的接口</li><li>设置了一些允许自动装配的接口，并且进行了赋值操作</li><li>在容器中还没有 XX 的 bean 的时候，帮我们注册 beanName 为 XX 的 singleton bean，这些是默认的环境 Bean</li></ul><h3 id=34-postprocessbeanfactory>3.4 postProcessBeanFactory</h3><blockquote><p>空方法，留给子类实现。用于自定义后置处理BeanFactory。</p></blockquote><h3 id=35-invokebeanfactorypostprocessors>3.5 invokeBeanFactoryPostProcessors</h3><blockquote><p>调用Bean工厂的后置处理器(内置+自定义)。该方法去还会实例化几个内置bean</p></blockquote><p><img class=lazyload src=/svg/loading.min.svg data-src=../images/image-20220623154010277.png data-srcset="../images/image-20220623154010277.png, ../images/image-20220623154010277.png 1.5x, ../images/image-20220623154010277.png 2x" data-sizes=auto alt=../images/image-20220623154010277.png title=image-20220623154010277></p><ul><li>调用BeanFactoryPostProcess</li><li>Bean定义注册BeanDefinitionMap中</li><li>实例化部分内置Bean</li></ul><h3 id=36-registerbeanpostprocessors>3.6 registerBeanPostProcessors</h3><blockquote><p>注册Bean的后置处理器</p></blockquote><h3 id=37-initmessagesource>3.7 initMessageSource</h3><blockquote><p>初始化国际资源</p></blockquote><h3 id=38-initapplicationeventmulticaster>3.8 initApplicationEventMulticaster</h3><blockquote><p>创建事件多播器</p></blockquote><ul><li><p>判断容器中有无，有直接拿，没有new()</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>new</span> <span class=n>SimpleApplicationEventMulticaster</span><span class=o>(</span><span class=n>beanFactory</span><span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>将对象注入到容器中</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>beanFactory</span><span class=o>.</span><span class=na>registerSingleton</span><span class=o>(</span><span class=n>APPLICATION_EVENT_MULTICASTER_BEAN_NAME</span><span class=o>,</span> <span class=k>this</span><span class=o>.</span><span class=na>applicationEventMulticaster</span><span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div></li></ul><h3 id=39-onrefresh>3.9 onRefresh</h3><blockquote><p>空方法，留给子类实现</p></blockquote><h3 id=310-registerlisteners>3.10 registerListeners</h3><blockquote><p>将事件监听器注册到多播器上</p></blockquote><ul><li><p>ApplicationListener接口监听器解析</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 循环获取容器中的早期对象，注册都多播器中
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>getApplicationEventMulticaster</span><span class=o>().</span><span class=na>addApplicationListenerBean</span><span class=o>(</span><span class=n>listenerBeanName</span><span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>解析@EventListener或基础ApplicationEvent</p></li><li><p>发布事件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>publishEvent</span><span class=o>()</span>
</span></span></code></pre></td></tr></table></div></div></li></ul><h3 id=311-finishbeanfactoryinitialization>3.11 finishBeanFactoryInitialization</h3><blockquote><p>实例化懒加载单例Bean的。Bean的创建过程（生命周期）</p></blockquote><ul><li>实例化</li><li>赋值</li><li>初始化</li><li>加入单例池</li></ul><h3 id=312-finishrefresh>3.12 finishRefresh</h3><blockquote><p>容器刷新，发布事件，<strong>Spring Cloud 就是在这里启动的</strong></p></blockquote><h3 id=313-resetcommoncaches>3.13 resetCommonCaches</h3><blockquote><p>启动完成后，清除过程中产生的元数据缓存</p></blockquote></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2022-06-15</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/spring%E7%94%9F%E6%80%81/>Spring生态</a>,&nbsp;<a href=/tags/ioc/>IOC</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/spring%E5%9F%BA%E7%A1%80/ class=prev rel=prev title="00. Spring Framework - 基础"><i class="fas fa-angle-left fa-fw"></i>00. Spring Framework - 基础</a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2021 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>yiwenup</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/twemoji@13.0.0/dist/twemoji.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:0},comment:{},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"PASDMWALPK",algoliaIndex:"index.zh-cn",algoliaSearchKey:"b42948e51daaa93df92381c8e2ac0f93",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"},twemoji:!0}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>