---
title: "分布式会话"
date: 2024-05-14T20:37:34+08:00
categories: ["分布式集群解决方案"]
tags: ["解决方案","技巧","分布式系统"]
draft: false
code:
  copy: true
toc:
  enable: true
---

## 一、分布式会话问题

在分布式集群场景下，由负载均衡服务器代理请求到后端服务的时候，**由于`HTTP`请求是无状态的，导致每次请求过来实际上没办法能够保持会话**。

在单体部署场景中通常是可以借助`Cookie`中的`JSessionId`去匹配服务端的`Session`保持一定会话。但是分布集群部署在诸如`Nginx`负载均衡服务器的轮询策略下，每一次请求都会路由到与之前不一样的服务器上，导致每一次请求都无法正常匹配到会话。

## 二、解决方案

### 2.1 Nginx的ip_hash策略

> 推荐指数：:star::star::star:

可以通过配置`Ngxin`的负载均衡策略为`ip_hash`，`Nginx`会为每次客户端请求所处的`ip`地址计算其`hash`值并路由到对应服务器，即**只要客户端`ip`不变，则`hash`值不变，则路由的最终服务不会变。**

- 优点：
  - 配置简单
  - 不侵入应用代码逻辑
- 缺点：
  - 服务端重启会导致`Session`丢失（小概率）
  - 服务端存在单点风险，只要服务端故障，则同一客户端的请求都会异常
  - 服务端负载问题，因为固定了某个客户端请求对应该服务端，如果客户端存在爆破行为，则服务会负载异常

### 2.2 Session同步

> 推荐指数：:star:

在很早之前的一种处理策略，是将`Tomcat`通过`Cluster`方式集群部署，针对集群中的`Tomcat`以组播机制通过`TCP`协议同步各自节点的`Session`记录，相当于每一个节点都会有全量的`Session`信息。

- 优点：
  - 不侵入应用代码逻辑
  - 便捷实现水平扩展
  - 不依赖负载均衡策略
  - 服务端重启不会导致`Session`丢失问题
- 缺点：
  - 由于服务间是同步策略，所以会有一定延迟性
  - 每个服务都存储全量`Session`信息，存在内存资源消耗问题
  - 并且由于占用大量内存资源，也拖慢了服务的性能

### 2.3 集中式Session

> 推荐指数：:star::star::star::star::star:

