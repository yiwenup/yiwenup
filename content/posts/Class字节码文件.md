---
title: "Class 字节码文件"
date: 2021-12-21T19:12:32+08:00
categories: ["Java"]
tags: ["Java","JVM","字节码"]
draft: false
code:
  copy: true
toc:
  enable: true
---

## 1. Java 类文件结构

![image-20220321183627199](../images/image-20220321183627199.png)

如上，是一个结构简单的 Java 类文件`Sample.java`，Java 类文件经过编译器进行源码编译之后，将会得到 .class 字节码文件。

## 2. Class 字节码文件

![image-20220322133203936](../images/image-20220322133203936.png)

## 3. 无符号数和表

Class 文件是以 8 个字节为一组基础单位的二进制流，各个数据项之间都是严格按顺序紧凑的排列在文件中的，之间没有任何分隔符。

Class 文件是采用类似于 C 语言的结构体的伪结构来进行数据存储的，这种伪结构有两种数据类型：**无符号数**、**表**。

无符号数：

​	**无符号数属于基本数据类型**，以 u1、u2、u4、u8 分别代表 1个字节、2个字节、4个字节、8个字节的无符号数，**由无符号数进而来描述数字、索引引用、数量值或者按 UTF8 编码构成的字符串**。

表：

​	**表是**由无符号整数或者其他表构成的**复合数据类型**，为了便于区分，所有表的命名习惯上都以`_info`结尾。表是用来描述有层次关系的复合结构的数据类型。

## 4. 魔数和版本号

字节码文件以二进制编码打开后，文件的**前 4 个字节即为魔数**，按如图所示即为：CA FE BA BE。用于也仅用于标识当前字节码文件能否被`JVM`接受。

**魔数之后的 4 个字节即为主次版本号**。前 2 个字节表示的是次版本号，如图所示即为：00 00，后 2 个字节表示的是主版本号，如图所示即为：00 34。主次版本号用于标识当前字节码文件可以被多少版本的`JVM`执行。如图的 00 00 00 34 对应的就是 JDK8，前后依次增减。

> 00 00 00 34 -> JDK 8
>
> 00 00 00 33 -> JDK 7
>
> 00 00 00 32 -> JDK 6

## 5. 常量池

### 5.1 常量池计数

![image-20220323193512531](../images/image-20220323193512531.png)

由于常量池中常量的数量是不固定的，所以在常量池的入口需要放置一个`u2`类型的数据，代表常量池容量计数值。

而计数习惯上**常量池计数是从 1 开始进行计数的**，如上图所示，常量池计数为 00 29 ，十六进制的 29，转为十进制即为 41，则表示当前常量池中的常量数量为 41。

常量池计数从 1 开始而不是从 0 开始的目的在于：如果后面某些指向常量池的索引值的数据在特定情况下需要表达 "不引用任何一个常量池项目" 的含义，则可以把索引值设置为 0 来表示。例如：匿名内部类本身是没有类名的，进行名称引用的时候则会将 index 执行 0。

### 5.2 常量池存放的内容

常量池主要存储两大类常量：字面量和符号引用。

![image-20220412150928758](../images/image-20220412150928758.png)

- 字面量：字面量比较接近于 Java 语言层面的常量概念。比如文本字符串或者被声明为`final`的常量。
- 符号引用：主要是与编译相关的内容，主要有如下几类常量：
  - 包名
  - 类全限定名
  - 字段名称和描述符
  - 方法名称和描述符
  - 方法句柄和方法类型（Method Handle、Method Type、Invoke Dynamic）
  - 动态调用点和动态常量（Dynamically-Computed Call Site、Dynamically-Computed Constant）

## 6. 访问标志

![image-20220412151339186](../images/image-20220412151339186.png)

> 常量池之后，紧跟着的 2 个字节表示当前类/接口的访问标志，这个标志用于识别一些类和接口层次的访问信息，包括：
>
> - 当前是接口还是类
> - 当前是否 public
> - 是否定义为 abstract
> - 是否声明为 final

![image-20220412151710301](../images/image-20220412151710301.png)

| 标志名称       | 标志值 | 含义                                                         |
| -------------- | ------ | ------------------------------------------------------------ |
| ACC_PUBLIC     | 0x0001 | 是否为 public 类型                                           |
| ACC_FINAL      | 0x0010 | 是否被声明为 final，只有类才可以设置                         |
| ACC_SUPER      | 0x0020 | 是否允许使用 invokespecial 字节码指令的新语义，invokespecial 指令的语义在 JDK 1.0.2 之后发生过改变，为了区别这条指令使用哪种语义，JDK 1.0.2 之后编译出来的类的这个标志得要为真 |
| ACC_INTERFACE  | 0x0200 | 标识这是一个接口                                             |
| ACC_ABSTRACT   | 0x0400 | 是否为 abstract 类型，对于接口和抽象类来说，这个标识为真，其他值类型为假 |
| ACC_SYNTHETIC  | 0x1000 | 标识这个类并不是由用户代码生成                               |
| ACC_ANNOTATION | 0x2000 | 标识这是一个注解                                             |
| ACC_ENUM       | 0x4000 | 标识这是一个枚举                                             |
| ACC_MODULE     | 0x8000 | 标识这是一个模块                                             |

