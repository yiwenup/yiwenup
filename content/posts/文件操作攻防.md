---
title: "16 文件操作攻防"
date: 2024-01-15T12:37:34+08:00
categories: ["Web安全和加速"]
tags: ["网络安全","技巧"]
draft: false
code:
  copy: true
toc:
  enable: true
---

## 一、文件上传攻防

文件上传漏洞是指攻击者上传了一个可执行的脚本文件，并通过此脚本文件获得了执行服务器端命令的能力。

要实现文件上传攻击，需要满足以下条件：

- 上传的文件能够被 Web 容器解释执行。所以文件上传后所在的目录要是 Web 容器所覆盖到的路径
- 用户能够从 Web 上访问这个文件。如果文件上传了，但用户无法通过 Web 访问，或者无法使得 Web 容器解释这个脚本，那么不能称之为漏洞
- 用户上传的文件若被安全检查、格式化、图片压缩等功能改变了内容，则也可能导致攻击不成功

文件上传攻击可能会导致的后果：

- 上传文件是 Web 脚本语言，服务器的 Web 容器解释并执行了用户上传的脚本，导致代码执行
- 上传文件是病毒、木马文件，黑客用以诱骗用户或者管理员下载执行
- 上传文件是钓鱼图片或为包含了脚本的图片，在某些版本的浏览器中会被作为脚本执行，被用于钓鱼和欺诈

解决方案：

- 检查上传文件扩展名白名单（不能依靠`MimeType`判断），不属于白名单内，不允许上传
- 上传文件的目录必须是`HTTP `请求无法直接访问到的。如果需要访问的，必须上传到其他（和 web 服务器不同的）域名下，并**设置该目录为不可执行目录**
- 上传文件要保存的文件名和目录名由系统根据时间生成，不允许用户自定义
-  图片上传，要通过处理（缩略图、水印等），无异常后才能保存到服务器
- 上传文件需要做日志记录，方便做日志审计

## 二、文件浏览攻防

文件浏览包含：文件下载、目录遍历等。导致漏洞的原因通常是设计层面的不合理，良好的设计应该是：不允许用户提交任意文件路径进行下载，而是用户单击下载按钮默认传递`ID`到后端，由后端服务根据`ID`匹配对应的下载路径执行下载操作。

不良的设计举例如下：允许用户提交任意文件路径，并把服务器上对应的文件直接发送给用户，这将造成任意文件下载威胁。如果让用户提交文件目录地址，就把目录下的文件列表发给用户，会造成目录遍历安全威胁。

```java
String path = request.getParameter("path");
OutputStream os = response.getOutputStream();
FileInputStream fis = new FileInputStream(path);
byte[] buff = new byte[1024];
int i=0;
while((i=fis.read(buff))>0){
	os.write(buff,0,i);
}
fis.close();
os.flush();
os.close();
```

解决方案：

- 要下载的文件地址、文件路径保存至数据库，让用户提交文件对应 ID 下载文件

- 下载文件之前做权限判断

- 文件放在 web 无法直接访问的目录下

- 记录文件下载日志

- `Nginx`要检查并关闭目录遍历服务，不允许提供目录遍历服务

  ```nginx
  # 这两行不允许添加，删除以关闭提供的目录遍历服务
  autoindex on;
  autoindex_exact_size on，
  ```

  
